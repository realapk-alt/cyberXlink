<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Manager Dashboard</title>
    <style>
        :root {
            --primary: #5c6bc0; /* Indigo */
            --primary-dark: #3f51b5;
            --accent: #ffb300; /* Amber */
            --text-color: #212121;
            --bg-light: #f5f5f5;
            --bg-dark: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg-light); color: var(--text-color); min-height: 100vh; }
        
        /* Login Screen */
        #loginScreen {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex; align-items: center; justify-content: center; height: 100vh; padding: 20px;
        }
        .login-card { 
            background: var(--bg-dark); padding: 40px; border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 380px; 
            text-align: center;
        }
        .login-card h2 { color: var(--primary-dark); margin-bottom: 20px; font-weight: 600; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="password"], input[type="url"] { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 15px; transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: var(--primary); }
        .btn-primary { 
            background: var(--primary); color: white; border: none; padding: 14px; 
            border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; 
            transition: background 0.3s; font-weight: 600; margin-top: 10px;
        }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-primary:disabled { background: #bdbdbd; cursor: not-allowed; }
        .message-box { padding: 10px; border-radius: 4px; margin: 15px 0; font-size: 14px; display: none; }
        .error { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        .success { background: #e8f5e9; color: #388e3c; border: 1px solid #a5d6a7; }
        .loader { width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dashboard Layout */
        #dashboardScreen { display: none; }
        .header { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; }
        .nav-bar { background: var(--bg-dark); padding: 10px 30px; border-bottom: 1px solid #eee; display: flex; gap: 15px; }
        .nav-btn { background: none; border: none; color: var(--text-color); padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; }
        .nav-btn:hover:not(.active) { background: var(--bg-light); }
        .container { padding: 30px; max-width: 1000px; margin: 0 auto; }
        .card { background: var(--bg-dark); padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-item { background: var(--bg-dark); padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2.5em; font-weight: bold; color: var(--accent); }
        .stat-label { font-size: 14px; color: #666; }

        /* Link List */
        .link-item { border: 1px solid #eee; border-left: 5px solid var(--primary); padding: 15px; border-radius: 4px; margin-bottom: 15px; }
        .link-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .link-info strong { font-size: 16px; }
        .link-url { background: #f0f0f0; padding: 8px; border-radius: 4px; font-size: 14px; word-break: break-all; margin-top: 8px; }
        .btn-small { padding: 6px 12px; font-size: 13px; border-radius: 4px; margin-left: 5px; cursor: pointer; }
        .btn-copy { background: #607d8b; color: white; border: none; }
        .btn-delete { background: #e57373; color: white; border: none; }
        .badge { background: var(--accent); color: var(--text-color); padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 10px; font-weight: 600; }
        .security-badge { background: #e0f2f1; color: #00796b; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-card">
            <h2>üîó Link Manager Login</h2>
            <div id="loginMessage" class="message-box"></div>
            <div class="form-group">
                <label for="username">üë§ Username</label>
                <input type="text" id="username" value="" autocomplete="off"> 
            </div>
            <div class="form-group">
                <label for="password">üîí Password</label>
                <input type="password" id="password" value="" autocomplete="new-password"> 
            </div>
            <button class="btn-primary" onclick="handleLogin()" id="loginBtn">
                <span id="loginBtnText">Login</span>
            </button>
        </div>
    </div>

    <div id="dashboardScreen">
        <div class="header">
            <h1>üîó Link Manager</h1>
            <div style="display: flex; align-items: center;">
                <span style="font-size: 14px; margin-right: 15px;" id="userBadge">Welcome, Admin</span>
                <button class="btn-primary btn-small" style="background: #e57373;" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="nav-bar">
            <button class="nav-btn active" onclick="showSection('manager', this)">Manage Links</button>
            <button class="nav-btn" onclick="showSection('create', this)">Create Link</button>
        </div>

        <div class="container">
            <div id="globalMessage" class="message-box"></div>

            <div id="managerSection" class="section">
                <h2>üìà Overall Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-number" id="totalLinks">0</div><div class="stat-label">Total Links</div></div>
                    <div class="stat-item"><div class="stat-number" id="totalClicks">0</div><div class="stat-label">Total Clicks</div></div>
                    <div class="stat-item"><div class="stat-number" id="protectedLinks">0</div><div class="stat-label">Protected Links</div></div>
                </div>
                
                <h2>üìÇ Your Links</h2>
                <div id="linksList">
                    <p style="text-align: center; color: #666; padding: 40px;">Loading links...</p>
                </div>
            </div>

            <div id="createSection" class="section" style="display: none;">
                <h2>‚ûï Create New Permanent Link</h2>
                <div class="card">
                    <div class="form-group">
                        <label for="linkName">üìù Link Name</label>
                        <input type="text" id="linkName" placeholder="e.g., Q3 Report PDF">
                    </div>
                    <div class="form-group">
                        <label for="actualUrl">üåê Target URL</label>
                        <input type="url" id="actualUrl" placeholder="https://mycompany.com/report.pdf">
                    </div>
                    <div class="form-group">
                        <label for="customSlug">üîó Custom Slug (Will be permanent)</label>
                        <input type="text" id="customSlug" placeholder="e.g., q3-report">
                    </div>
                    <div class="form-group">
                        <label for="linkPassword">üîí Access Password (Optional)</label>
                        <input type="text" id="linkPassword" placeholder="Keep blank for public link">
                    </div>
                    <button class="btn-primary" onclick="addNewLink()" id="createLinkBtn">
                        <span id="createLinkBtnText">Create Permanent Link</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION: Apps Script URL (UPDATED) ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbwpM84rSRsrkjMOJm_m84hdZUlC5GIgkWrliFcW8nXKEpHfcy_jt_GNkbq-o15pCma8QA/exec'; 
        
        // --- 2. GLOBAL STATE ---
        let allLinksData = [];
        const sessionKey = 'linkAdminSession';

        // --- 3. UTILITY FUNCTIONS ---
        function getPermanentUrl(slug, password) {
            let url = `${API_URL}?s=${slug}`;
            if (password) {
                url += `&p=${password}`;
            }
            return url;
        }

        function showMessage(message, type, targetId = 'loginMessage') {
            const messageDiv = document.getElementById(targetId);
            if (!messageDiv) return;
            messageDiv.textContent = message;
            messageDiv.className = `message-box ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }

        function showSection(sectionId, element) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId + 'Section').style.display = 'block';
            element.classList.add('active');
        }

        function updateStats() {
            const total = allLinksData.length;
            const totalClicks = allLinksData.reduce((sum, link) => sum + (parseInt(link.clicks) || 0), 0);
            const protectedCount = allLinksData.filter(link => link.password).length;
            
            document.getElementById('totalLinks').textContent = total;
            document.getElementById('totalClicks').textContent = totalClicks;
            document.getElementById('protectedLinks').textContent = protectedCount;
        }

        function displayLinks() {
            const list = document.getElementById('linksList');
            if (allLinksData.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No links created yet.</p>';
                return;
            }

            let html = '';
            allLinksData.forEach(link => {
                const permanentUrl = getPermanentUrl(link.slug, link.password);
                const securityBadge = link.password ? 
                    `<span class="security-badge">üîí Protected</span>` : 
                    `<span class="security-badge" style="background: #e3f2fd; color: #1e88e5;">üîì Public</span>`;

                html += `
                    <div class="link-item">
                        <div class="link-info">
                            <div>
                                <strong>${link.name || 'Unnamed Link'}</strong>
                                ${securityBadge}
                                <span class="badge">${link.clicks || 0} Clicks</span>
                            </div>
                            <div style="font-size: 12px; color: #999;">
                                Created: ${new Date(link.created).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="link-url" style="color: var(--primary-dark); font-weight: 500;">
                            ${permanentUrl}
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn-primary btn-small btn-copy" onclick="copyToClipboard('${permanentUrl}')">
                                Copy Link
                            </button>
                            <button class="btn-primary btn-small" style="background: #4caf50;" onclick="window.open('${permanentUrl}', '_blank')">
                                Test
                            </button>
                            <button class="btn-primary btn-small btn-delete" onclick="deleteLink('${link.slug}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('Link copied to clipboard!', 'success', 'globalMessage');
            });
        }

        // --- 4. CORE FETCH FUNCTIONS (NOW USING GET) ---

        // Helper to perform GET request and return JSON data
        async function fetchJsonData(queryString) {
            const url = `${API_URL}?${queryString}`;
            try {
                const response = await fetch(url);
                return response.json();
            } catch (error) {
                throw new Error('Network/Server Connection Error.');
            }
        }

        async function fetchLinks() {
            try {
                // Show loading state
                document.getElementById('linksList').innerHTML = '<p style="text-align: center; color: #667eea; padding: 40px;">Fetching links...</p>';
                
                const result = await fetchJsonData('action=data');
                
                if (result.success) {
                    allLinksData = result.data || [];
                    displayLinks();
                    updateStats();
                } else {
                    showMessage(`Error fetching links: ${result.message}`, 'error', 'globalMessage');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error', 'globalMessage');
            }
        }

        async function addNewLink() {
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('actualUrl').value.trim();
            const slug = document.getElementById('customSlug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
            const password = document.getElementById('linkPassword').value.trim();
            
            // --- FINAL VALIDATION CHECK ---
            if (!name || !url || !slug) {
                showMessage('Please fill Link Name, Target URL, and Custom Slug.', 'error', 'globalMessage');
                return;
            }
            if (!url.startsWith('http')) {
                showMessage('Target URL must start with http:// or https://', 'error', 'globalMessage');
                return;
            }
            if (slug.includes(' ')) {
                showMessage('Slug cannot contain spaces.', 'error', 'globalMessage');
                return;
            }
            
            const btn = document.getElementById('createLinkBtn');
            btn.disabled = true;
            document.getElementById('createLinkBtnText').innerHTML = '<span class="loader"></span> Creating...';

            const linkData = { name, actualUrl: url, slug, password };
            const encodedLinkData = encodeURIComponent(JSON.stringify(linkData));
            const queryString = `action=add&linkData=${encodedLinkData}`;

            try {
                const result = await fetchJsonData(queryString);

                if (result.success) {
                    showMessage('‚úÖ ' + result.message, 'success', 'globalMessage');
                    document.getElementById('linkName').value = document.getElementById('actualUrl').value = document.getElementById('customSlug').value = document.getElementById('linkPassword').value = '';
                    await fetchLinks();
                    showSection('manager', document.querySelector('.nav-btn'));
                } else {
                    showMessage('‚ùå ' + result.message, 'error', 'globalMessage');
                }
            } catch (error) {
                showMessage(`‚ùå Error: ${error.message}`, 'error', 'globalMessage');
            } finally {
                btn.disabled = false;
                document.getElementById('createLinkBtnText').textContent = 'Create Permanent Link';
            }
        }

        async function deleteLink(slug) {
            if (!confirm(`Are you sure you want to delete the link with slug: ${slug}?`)) return;

            const queryString = `action=delete&slug=${slug}`;
            try {
                const result = await fetchJsonData(queryString);

                if (result.success) {
                    showMessage('‚úÖ ' + result.message, 'success', 'globalMessage');
                    await fetchLinks();
                } else {
                    showMessage('‚ùå ' + result.message, 'error', 'globalMessage');
                }
            } catch (error) {
                showMessage(`‚ùå Error: ${error.message}`, 'error', 'globalMessage');
            }
        }

        // --- 5. AUTHENTICATION (Uses Window Location Redirect) ---

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showMessage('Please enter both username and password.');
                return;
            }

            const loginUrl = `${API_URL}?action=login&username=${username}&password=${password}`;
            
            window.location.href = loginUrl;
        }

        // --- 6. INITIALIZATION & Session Handling ---
        
        function renderDashboard() {
            const urlParams = new URLSearchParams(window.location.search);
            const authSuccess = urlParams.get('auth_success');
            const message = urlParams.get('message');
            const userData = urlParams.get('user');

            if (authSuccess !== null) {
                const redirectUrl = window.location.origin + window.location.pathname;
                
                if (authSuccess === 'true' && userData) {
                    const sessionData = JSON.parse(decodeURIComponent(userData));
                    sessionStorage.setItem(sessionKey, JSON.stringify({ loggedIn: true, username: sessionData.username }));
                    
                    window.location.replace(redirectUrl);
                    return;
                } else if (authSuccess === 'false') {
                    showMessage('‚ùå ' + (decodeURIComponent(message) || 'Login failed.'), 'error');
                    window.history.replaceState(null, '', redirectUrl);
                }
            }
            
            const session = JSON.parse(sessionStorage.getItem(sessionKey));
            
            if (session && session.loggedIn) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboardScreen').style.display = 'block';
                document.getElementById('userBadge').textContent = `Welcome, ${session.username}`;
                fetchLinks();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('dashboardScreen').style.display = 'none';
            }
        }

        function logout() {
            sessionStorage.removeItem(sessionKey);
            window.location.reload();
        }

        // Initial check on load
        renderDashboard();
    </script>
</body>
</html>
