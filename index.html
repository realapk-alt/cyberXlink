<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Link Manager</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script> 
    
    <style>
        :root {
            --primary: #5c6bc0; /* Indigo */
            --primary-dark: #3f51b5;
            --accent: #ffb300; /* Amber */
            --text-color: #212121;
            --bg-light: #f5f5f5;
            --bg-dark: #ffffff;
            --danger: #e57373;
            --success: #4caf50;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg-light); color: var(--text-color); min-height: 100vh; }
        
        /* Login Screen - Enhanced Design */
        #loginScreen {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex; align-items: center; justify-content: center; height: 100vh; padding: 20px;
        }
        .login-card { 
            background: var(--bg-dark); padding: 40px; border-radius: 12px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); width: 100%; max-width: 400px; 
            text-align: center;
        }
        .login-card h2 { color: var(--primary); margin-bottom: 25px; font-weight: 700; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="password"], input[type="url"] { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 15px; transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: var(--primary); }
        .btn-primary { 
            background: var(--primary); color: white; border: none; padding: 14px; 
            border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; 
            transition: background 0.3s; font-weight: 600; margin-top: 10px;
        }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-primary:disabled { background: #bdbdbd; cursor: not-allowed; }
        
        /* Dashboard Layout */
        #dashboardScreen { display: none; }
        .header { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-bar { background: var(--bg-dark); padding: 10px 30px; border-bottom: 1px solid #eee; display: flex; gap: 15px; }
        .nav-btn.active { background: var(--primary); color: white; }
        .container { padding: 30px; max-width: 1000px; margin: 0 auto; }
        .card { background: var(--bg-dark); padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* Link List */
        .link-item { border: 1px solid #eee; border-left: 5px solid var(--primary); padding: 15px; border-radius: 4px; margin-bottom: 15px; }
        .link-url { background: #f0f0f0; padding: 8px; border-radius: 4px; font-size: 14px; word-break: break-all; margin-top: 8px; }
        .btn-small { padding: 6px 12px; font-size: 13px; border-radius: 4px; margin-left: 5px; cursor: pointer; }
        .btn-delete { background: var(--danger); color: white; border: none; }
        .btn-edit { background: var(--accent); color: var(--text-color); border: none; }
        .security-badge { background: #e0f2f1; color: #00796b; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        
        /* Modal */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; 
            z-index: 1000;
        }
        .modal-content { 
            background: white; padding: 30px; border-radius: 10px; max-width: 500px; 
            width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 { color: var(--primary-dark); margin-bottom: 20px; }
        .footer { text-align: center; padding: 10px 0; font-size: 12px; color: #888; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-card">
            <h2>üîó Admin Access</h2>
            <div id="loginMessage" class="message-box"></div>
            <div class="form-group">
                <label for="username">üë§ Username</label>
                <input type="text" id="username" value="" autocomplete="off"> 
            </div>
            <div class="form-group">
                <label for="password">üîí Password</label>
                <input type="password" id="password" value="" autocomplete="new-password"> 
            </div>
            <button class="btn-primary" onclick="handleLogin()" id="loginBtn">
                <span id="loginBtnText">Login</span>
            </button>
        </div>
    </div>

    <div id="dashboardScreen">
        <div class="header">
            <h1>üîó Link Manager</h1>
            <div style="display: flex; align-items: center;">
                <span style="font-size: 14px; margin-right: 15px;" id="userBadge">Welcome, Admin</span>
                <button class="btn-primary btn-small" style="background: var(--danger);" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="nav-bar">
            <button class="nav-btn active" onclick="showSection('manager', this)">Manage Links</button>
            <button class="nav-btn" onclick="showSection('create', this)">Create Link</button>
        </div>

        <div class="container">
            <div id="globalMessage" class="message-box"></div>

            <div id="managerSection" class="section">
                <h2>üìà Overall Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-number" id="totalLinks">0</div><div class="stat-label">Total Links</div></div>
                    <div class="stat-item"><div class="stat-number" id="totalClicks">0</div><div class="stat-label">Total Clicks</div></div>
                    <div class="stat-item"><div class="stat-number" id="protectedLinks">0</div><div class="stat-label">Protected Links</div></div>
                </div>
                
                <h2>üìÇ Your Links</h2>
                <div id="linksList">
                    <p style="text-align: center; color: #666; padding: 40px;">Loading links...</p>
                </div>
            </div>

            <div id="createSection" class="section" style="display: none;">
                <h2>‚ûï Create New Permanent Link</h2>
                <div class="card">
                    <div class="form-group">
                        <label for="linkName">üìù Link Name</label>
                        <input type="text" id="linkName" placeholder="e.g., Q3 Report PDF">
                    </div>
                    <div class="form-group">
                        <label for="actualUrl">üåê Target URL</label>
                        <input type="url" id="actualUrl" placeholder="https://mycompany.com/report.pdf">
                    </div>
                    <div class="form-group">
                        <label for="customSlug">üîó Custom Slug (Will be permanent)</label>
                        <input type="text" id="customSlug" placeholder="e.g., q3-report">
                    </div>
                    <div class="form-group">
                        <label for="linkPassword">üîí Access Password (Optional)</label>
                        <input type="text" id="linkPassword" placeholder="Keep blank for public link">
                    </div>
                    <button class="btn-primary" onclick="addNewLink()" id="createLinkBtn">
                        <span id="createLinkBtnText">Create Permanent Link</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚úèÔ∏è Edit Link Details</h3>
            <p style="color: var(--danger); font-size: 14px; margin-bottom: 15px;">Permanent Link (Slug) will NOT change.</p>
            <div class="form-group">
                <label for="editLinkName">üìù Link Name</label>
                <input type="text" id="editLinkName">
            </div>
            <div class="form-group">
                <label for="editActualUrl">üåê Target URL</label>
                <input type="url" id="editActualUrl">
            </div>
            <div class="form-group">
                <label for="editLinkPassword">üîí Access Password</label>
                <input type="text" id="editLinkPassword">
            </div>
            <button class="btn-primary" style="background: var(--success);" onclick="saveEditedLink()">
                Save Changes
            </button>
            <button class="btn-primary" style="background: #999; margin-top: 5px;" onclick="document.getElementById('editModal').style.display='none'">
                Cancel
            </button>
            <input type="hidden" id="editSlugHidden">
        </div>
    </div>
    
    <div class="footer">
        ¬© Copyright - REAL APK
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION (Your Details) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDWDlR8iOooisUPdGusb5wysG1fciHNexg",
            authDomain: "cyberxlink-db.firebaseapp.com",
            databaseURL: "https://cyberxlink-db-default-rtdb.firebaseio.com",
            projectId: "cyberxlink-db",
            storageBucket: "cyberxlink-db.firebasestorage.app",
            messagingSenderId: "905454397308",
            appId: "1:905454397308:web:8e1aa871d39609e339e6f9",
        };

        // Initialize Firebase and Database Reference
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const linksRef = db.ref('links'); 
        const usersRef = db.ref('users'); // Reference to the users for multi-login
        
        // --- 2. GLOBAL STATE ---
        let allLinksData = [];
        const sessionKey = 'linkAdminSession';

        // --- 3. UTILITY FUNCTIONS ---
        
        function getPermanentUrl(slug, password) {
            // Permanent Link uses the GitHub Pages URL itself (hash mode)
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '').replace(/\/$/, '');
            let url = `${baseUrl}#/${slug}`; 
            if (password) {
                url += `?p=${password}`;
            }
            return url;
        }

        function showMessage(message, type, targetId = 'loginMessage') {
            const messageDiv = document.getElementById(targetId);
            if (!messageDiv) return;
            messageDiv.textContent = message;
            messageDiv.className = `message-box ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }

        function showSection(sectionId, element) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId + 'Section').style.display = 'block';
            element.classList.add('active');
        }

        function updateStats() {
            const total = allLinksData.length;
            const totalClicks = allLinksData.reduce((sum, link) => sum + (parseInt(link.clicks) || 0), 0);
            const protectedCount = allLinksData.filter(link => link.password && link.password.length > 0).length;
            
            document.getElementById('totalLinks').textContent = total;
            document.getElementById('totalClicks').textContent = totalClicks;
            document.getElementById('protectedLinks').textContent = protectedCount;
        }

        function displayLinks() {
            const list = document.getElementById('linksList');
            if (allLinksData.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No links created yet.</p>';
                return;
            }

            let html = '';
            allLinksData.forEach(link => {
                const permanentUrl = getPermanentUrl(link.slug, link.password);
                const securityBadge = link.password ? 
                    `<span class="security-badge">üîí Protected</span>` : 
                    `<span class="security-badge" style="background: #e3f2fd; color: #1e88e5;">üîì Public</span>`;

                html += `
                    <div class="link-item">
                        <div class="link-info">
                            <div>
                                <strong>${link.name || 'Unnamed Link'}</strong>
                                ${securityBadge}
                                <span class="badge">${link.clicks || 0} Clicks</span>
                            </div>
                            <div style="font-size: 12px; color: #999;">
                                Created: ${new Date(link.created).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="link-url" style="color: var(--primary-dark); font-weight: 500;">
                            ${permanentUrl}
                        </div>
                        <div class="link-actions">
                            <button class="btn-primary btn-small btn-copy" onclick="copyToClipboard('${permanentUrl}')">
                                üìã Copy Link
                            </button>
                            <button class="btn-primary btn-small btn-edit" onclick="openEditModal('${link.slug}')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn-primary btn-small" style="background: var(--success);" onclick="window.open('${permanentUrl}', '_blank')">
                                üß™ Test
                            </button>
                            <button class="btn-primary btn-small btn-delete" onclick="deleteLink('${link.slug}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('Link copied to clipboard!', 'success', 'globalMessage');
            });
        }
        
        // --- 6. LINK CRUD OPERATIONS ---

        function addNewLink() {
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('actualUrl').value.trim();
            const slug = document.getElementById('customSlug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
            const password = document.getElementById('linkPassword').value.trim();
            
            if (!name || !url || !slug || !url.startsWith('http')) {
                showMessage('Please fill all fields correctly (URL must start with http).', 'error', 'globalMessage');
                return;
            }

            if (allLinksData.some(link => link.slug === slug)) {
                 showMessage('‚ùå This slug already exists.', 'error', 'globalMessage');
                return;
            }
            
            const linkData = { 
                slug: slug,
                url: url,
                name: name,
                password: password,
                clicks: 0,
                created: new Date().toISOString()
            };

            linksRef.child(slug).set(linkData)
                .then(() => {
                    showMessage('‚úÖ Link created successfully!', 'success', 'globalMessage');
                    document.getElementById('linkName').value = document.getElementById('actualUrl').value = document.getElementById('customSlug').value = document.getElementById('linkPassword').value = '';
                    showSection('manager', document.querySelector('.nav-btn'));
                })
                .catch(error => {
                    showMessage('‚ùå Database Write Error: ' + error.message, 'error', 'globalMessage');
                });
        }
        
        function deleteLink(slug) {
            if (!confirm(`Are you sure you want to delete the link with slug: ${slug}?`)) return;

            linksRef.child(slug).remove()
                .then(() => {
                    showMessage('‚úÖ Link deleted successfully!', 'success', 'globalMessage');
                })
                .catch(error => {
                    showMessage('‚ùå Database Delete Error: ' + error.message, 'error', 'globalMessage');
                });
        }
        
        // --- 7. EDIT MODAL LOGIC (New Feature) ---
        
        let currentEditingSlug = null;

        function openEditModal(slug) {
            const link = allLinksData.find(l => l.slug === slug);
            if (!link) return;

            currentEditingSlug = slug;
            document.getElementById('editSlugHidden').value = slug;
            document.getElementById('editLinkName').value = link.name;
            document.getElementById('editActualUrl').value = link.url;
            document.getElementById('editLinkPassword').value = link.password || '';
            document.getElementById('editModal').style.display = 'flex';
        }

        function saveEditedLink() {
            if (!currentEditingSlug) return;
            
            const newName = document.getElementById('editLinkName').value.trim();
            const newUrl = document.getElementById('editActualUrl').value.trim();
            const newPassword = document.getElementById('editLinkPassword').value.trim();
            
            if (!newName || !newUrl || !newUrl.startsWith('http')) {
                alert("Please ensure Name and valid Target URL are provided.");
                return;
            }

            // Update only the mutable fields in Firebase
            linksRef.child(currentEditingSlug).update({
                name: newName,
                url: newUrl, // Target URL is updated
                password: newPassword,
                // Slug and Clicks remain unchanged!
            })
            .then(() => {
                showMessage('‚úÖ Link updated successfully!', 'success', 'globalMessage');
                document.getElementById('editModal').style.display = 'none';
            })
            .catch(error => {
                showMessage('‚ùå Update Error: ' + error.message, 'error', 'globalMessage');
            });
        }


        // --- 8. AUTHENTICATION (Firebase Login) ---

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!username || !password) {
                showMessage('Please enter both username and password.', 'error');
                return;
            }

            loginBtn.disabled = true;
            document.getElementById('loginBtnText').innerHTML = '<span class="loader"></span> Authenticating...';

            usersRef.orderByChild('username').equalTo(username).once('value')
                .then(snapshot => {
                    loginBtn.disabled = false;
                    document.getElementById('loginBtnText').textContent = 'Login';
                    
                    const users = snapshot.val();
                    
                    if (users) {
                        for (let key in users) {
                            const user = users[key];
                            if (user.password === password) {
                                sessionStorage.setItem(sessionKey, JSON.stringify({ loggedIn: true, username: user.username }));
                                showMessage(`‚úÖ Login successful! Welcome, ${user.username}`, 'success');
                                setTimeout(() => renderDashboard(), 500);
                                return;
                            }
                        }
                    }
                    
                    showMessage('‚ùå Invalid username or password.', 'error');
                    
                })
                .catch(error => {
                    loginBtn.disabled = false;
                    document.getElementById('loginBtnText').textContent = 'Login';
                    showMessage('‚ùå Database Error: Could not verify login.', 'error');
                    console.error("Login verification failed:", error);
                });
        }


        // --- 9. REDIRECT CHECKER & INITIALIZATION ---

        function checkRedirect() {
            // Check for slug in the URL Hash (e.g., #/my-slug)
            const hashPath = window.location.hash;
            if (hashPath.startsWith('#/')) {
                const parts = hashPath.substring(2).split('?');
                const slug = parts[0];
                const password = (parts.length > 1) ? new URLSearchParams(parts[1]).get('p') : null;
                
                // Fetch the link data from Firebase
                linksRef.child(slug).once('value')
                    .then(snapshot => {
                        const link = snapshot.val();
                        if (link) {
                            if (link.password && link.password !== password) {
                                alert("üîí Incorrect password for this link.");
                                window.location.hash = '';
                                return;
                            }
                            
                            // Update clicks and redirect
                            linksRef.child(slug).update({ clicks: (link.clicks || 0) + 1 });
                            window.location.replace(link.url);
                        } else {
                            window.location.hash = '';
                            alert('‚ùå Error: Link not found.');
                        }
                    })
                    .catch(error => {
                        console.error("Redirect check failed:", error);
                        window.location.hash = '';
                    });
                
                return true;
            }
            return false;
        }

        function renderDashboard() {
            if (checkRedirect()) {
                return; 
            }
            
            const session = JSON.parse(sessionStorage.getItem(sessionKey));
            
            if (session && session.loggedIn) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboardScreen').style.display = 'block';
                document.getElementById('userBadge').textContent = `Welcome, ${session.username}`;
                // Start real-time fetching of links
                linksRef.on('value', (snapshot) => {
                    const linksObject = snapshot.val() || {};
                    const linksArray = Object.keys(linksObject).map(key => linksObject[key]);
                    allLinksData = linksArray;
                    displayLinks();
                    updateStats();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('dashboardScreen').style.display = 'none';
            }
        }

        function logout() {
            sessionStorage.removeItem(sessionKey);
            window.location.hash = '';
            window.location.reload();
        }
        
        // Initial check on load
        renderDashboard();
    </script>
</body>
</html>
